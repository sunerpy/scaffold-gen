import { computed } from "vue";
import { useSettingsStore } from "@/stores/settingsStore";

export type ThemeMode = "light" | "dark" | "system";

/**
 * 主题管理 Composable
 * 提供主题切换和状态管理的便捷接口
 */
export function useTheme() {
  const settingsStore = useSettingsStore();

  // 响应式状态
  const themeMode = computed(() => settingsStore.settings.theme);
  const systemPrefersDark = computed(() => {
    if (typeof window !== "undefined" && window.matchMedia) {
      return window.matchMedia("(prefers-color-scheme: dark)").matches;
    }
    return false;
  });

  const isDark = computed(() => {
    if (themeMode.value === "system") {
      return systemPrefersDark.value;
    }
    return themeMode.value === "dark";
  });

  const currentTheme = computed(() => {
    return isDark.value ? "dark" : "light";
  });

  // 主题切换方法
  const setTheme = async (mode: ThemeMode) => {
    await settingsStore.setTheme(mode);
  };

  const toggleTheme = async () => {
    const current = themeMode.value;
    if (current === "light") {
      await setTheme("dark");
    } else if (current === "dark") {
      await setTheme("system");
    } else {
      await setTheme("light");
    }
  };

  const toggleLightDark = async () => {
    if (themeMode.value === "system") {
      await setTheme(systemPrefersDark.value ? "light" : "dark");
    } else {
      await setTheme(themeMode.value === "light" ? "dark" : "light");
    }
  };

  // 主题相关的CSS类名
  const themeClasses = computed(() => {
    return currentTheme.value;
  });

  // 获取主题相关的Tailwind类名
  const getThemeClass = (lightClass: string, darkClass: string) => {
    return isDark.value ? darkClass : lightClass;
  };

  // 主题图标
  const themeIcon = computed(() => {
    switch (themeMode.value) {
      case "light":
        return "sunny";
      case "dark":
        return "moon";
      case "system":
        return "desktop";
      default:
        return "desktop";
    }
  });

  // 主题显示名称
  const themeLabel = computed(() => {
    switch (themeMode.value) {
      case "light":
        return "明亮模式";
      case "dark":
        return "深色模式";
      case "system":
        return "跟随系统";
      default:
        return "跟随系统";
    }
  });

  // 初始化主题
  const initTheme = async () => {
    await settingsStore.loadSettings();
  };

  return {
    // 状态
    themeMode,
    isDark,
    currentTheme,
    systemPrefersDark,
    themeClasses,
    themeIcon,
    themeLabel,

    // 方法
    setTheme,
    toggleTheme,
    toggleLightDark,
    getThemeClass,
    initTheme
  };
}
