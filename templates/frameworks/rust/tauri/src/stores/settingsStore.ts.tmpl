import { defineStore } from "pinia";
import { ref, watch } from "vue";
import { setLocale } from "@/utils/i18n";
import { invoke, isTauri } from "@tauri-apps/api/core";
import { debug, info, error as logError } from "@tauri-apps/plugin-log";

const isTauriBool = isTauri();

// 应用设置接口
interface AppSettings {
  theme: "light" | "dark" | "system";
  language: "zh-CN" | "en-US";
  fontSize: number;
  sidebarCollapsed: boolean;
  sidebarWidth: number;
}

// 默认设置
const defaultSettings: AppSettings = {
  theme: "system",
  language: "zh-CN",
  fontSize: 14,
  sidebarCollapsed: false,
  sidebarWidth: 20
};

export const useSettingsStore = defineStore("settings", () => {
  // 响应式设置状态
  const settings = ref<AppSettings>({ ...defaultSettings });
  const isLoaded = ref(false);

  // 系统主题监听器
  let systemThemeListener: MediaQueryList | null = null;

  // 设置系统主题监听
  const setupSystemThemeListener = () => {
    if (typeof window !== "undefined") {
      systemThemeListener = window.matchMedia("(prefers-color-scheme: dark)");
      const handleSystemThemeChange = () => {
        if (settings.value.theme === "system") {
          if (isTauriBool) {
            info("[systemThemeListener] 系统主题发生变化，重新应用主题");
          }
          applyTheme();
        }
      };
      systemThemeListener.addEventListener("change", handleSystemThemeChange);
    }
  };

  // 应用主题到DOM
  const applyTheme = () => {
    const theme = settings.value.theme;
    debug(`[applyTheme] 开始应用主题: ${theme}`);

    const body = document.body;
    const html = document.documentElement;

    body.classList.remove("light", "dark");
    html.classList.remove("light", "dark");
    body.removeAttribute("data-theme");
    html.removeAttribute("data-theme");

    let actualTheme = theme;

    if (theme === "system") {
      const prefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      actualTheme = prefersDark ? "dark" : "light";
    }

    body.classList.add(actualTheme);
    html.classList.add(actualTheme);
    body.setAttribute("data-theme", actualTheme);
    html.setAttribute("data-theme", actualTheme);

    info(`[applyTheme] 主题应用完成: ${theme} -> ${actualTheme}`);
  };

  // 应用字体大小
  const applyFontSize = () => {
    const fontSize = settings.value.fontSize;
    debug(`[applyFontSize] 开始应用字体大小: ${fontSize}px`);
    document.documentElement.style.setProperty(
      "--app-font-size",
      `${fontSize}px`
    );
    info(`[applyFontSize] 字体大小应用完成: ${fontSize}px`);
  };

  // 应用语言
  const applyLanguage = () => {
    const langCode = settings.value.language === "zh-CN" ? "zh" : "en";
    debug(`[applyLanguage] 应用语言设置: ${settings.value.language}`);
    setLocale(langCode as any);
    info(`[applyLanguage] 语言应用完成: ${settings.value.language}`);
  };

  // 加载设置
  const loadSettings = async () => {
    debug("[loadSettings] 开始加载用户设置");

    if (!isTauriBool) {
      debug("[loadSettings] 非Tauri环境，从localStorage加载设置");
      try {
        const savedSettings = localStorage.getItem("app-settings");
        if (savedSettings) {
          settings.value = { ...defaultSettings, ...JSON.parse(savedSettings) };
          debug(
            `[loadSettings] 从localStorage成功加载设置: theme=${settings.value.theme}`
          );
        }
      } catch (error) {
        console.error("Failed to load settings from localStorage:", error);
      }
      isLoaded.value = true;
      applyTheme();
      applyFontSize();
      applyLanguage();
      setupSystemThemeListener();
      return;
    }

    try {
      debug("[loadSettings] Tauri环境，从后端加载设置");
      const userSettings = await invoke<AppSettings>("load_user_settings");
      if (userSettings) {
        settings.value = { ...defaultSettings, ...userSettings };
        debug(
          `[loadSettings] 从后端成功加载设置: theme=${settings.value.theme}`
        );
      }
      isLoaded.value = true;
      applyTheme();
      applyFontSize();
      applyLanguage();
      setupSystemThemeListener();
    } catch (error) {
      logError(`[loadSettings] Failed to load settings: ${error}`);
      settings.value = { ...defaultSettings };
      isLoaded.value = true;
      applyTheme();
      applyFontSize();
      applyLanguage();
      setupSystemThemeListener();
    }
  };

  // 保存设置
  const saveSettings = async () => {
    debug(`[saveSettings] 开始保存设置: theme=${settings.value.theme}`);

    if (!isTauriBool) {
      try {
        localStorage.setItem("app-settings", JSON.stringify(settings.value));
        debug("[saveSettings] 设置已保存到localStorage");
      } catch (error) {
        console.error("Failed to save settings to localStorage:", error);
      }
      return;
    }

    try {
      await invoke("save_user_settings", { settings: settings.value });
      debug("[saveSettings] 设置已保存到后端");
    } catch (error) {
      logError(`[saveSettings] Failed to save settings: ${error}`);
    }
  };

  // 更新单个设置项
  const updateSetting = async <K extends keyof AppSettings>(
    key: K,
    value: AppSettings[K]
  ) => {
    settings.value[key] = value;
    await saveSettings();
  };

  // 重置设置
  const resetSettings = async () => {
    settings.value = { ...defaultSettings };
    await saveSettings();
  };

  // 监听设置变化并自动保存
  watch(
    settings,
    () => {
      if (isLoaded.value) {
        saveSettings();
      }
    },
    { deep: true }
  );

  // 便捷的设置方法
  const setTheme = async (theme: AppSettings["theme"]) => {
    debug(`[setTheme] 设置主题: ${theme}`);
    await updateSetting("theme", theme);
    applyTheme();
  };

  const setLanguage = async (language: AppSettings["language"]) => {
    debug(`[setLanguage] 设置语言: ${language}`);
    await updateSetting("language", language);
    applyLanguage();
  };

  const setFontSize = async (fontSize: number) => {
    debug(`[setFontSize] 设置字体大小: ${fontSize}px`);
    await updateSetting("fontSize", fontSize);
    applyFontSize();
  };

  const setSidebarCollapsed = async (collapsed: boolean) => {
    await updateSetting("sidebarCollapsed", collapsed);
  };

  const setSidebarWidth = async (width: number) => {
    const clampedWidth = Math.max(10, Math.min(30, width));
    await updateSetting("sidebarWidth", clampedWidth);
  };

  return {
    // 状态
    settings,
    isLoaded,

    // 方法
    loadSettings,
    saveSettings,
    updateSetting,
    resetSettings,
    setTheme,
    setLanguage,
    setFontSize,
    setSidebarCollapsed,
    setSidebarWidth,
    applyTheme,
    applyFontSize,
    applyLanguage
  };
});
