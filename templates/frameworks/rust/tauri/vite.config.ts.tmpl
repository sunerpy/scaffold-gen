import { type UserConfigExport, type ConfigEnv } from "vite";
import vue from "@vitejs/plugin-vue";
import AutoImport from "unplugin-auto-import/vite";
import Components from "unplugin-vue-components/vite";
import { ElementPlusResolver } from "unplugin-vue-components/resolvers";
import { fileURLToPath, URL } from "node:url";

// https://vite.dev/config/
export default ({ mode }: ConfigEnv): UserConfigExport => {
  const host = process.env.TAURI_DEV_HOST;
  const isProduction = mode === "production";

  return {
    plugins: [
      vue(),
      AutoImport({
        resolvers: [ElementPlusResolver()],
        imports: ["vue", "vue-router", "pinia", "vue-i18n"],
        dts: true
      }),
      Components({
        resolvers: [ElementPlusResolver()],
        dts: true
      })
    ],

    resolve: {
      alias: {
        "@": fileURLToPath(new URL("./src", import.meta.url))
      }
    },

    // Vite options tailored for Tauri development
    clearScreen: false,
    server: {
      port: 1420,
      strictPort: true,
      host: host || "0.0.0.0",
      hmr: host
        ? {
            protocol: "ws",
            host,
            port: 1421
          }
        : undefined,
      watch: {
        ignored: ["**/src-tauri/**"]
      }
    },
    build: {
      rollupOptions: {
        output: {
          manualChunks: {
            "vue-vendor": ["vue", "vue-router", "pinia"],
            "element-plus": ["element-plus/es"],
            "tauri-plugins": ["@tauri-apps/plugin-log", "@tauri-apps/api"]
          }
        }
      }
    },
    esbuild: {
      drop: isProduction ? ["console", "debugger"] : []
    }
  };
};
